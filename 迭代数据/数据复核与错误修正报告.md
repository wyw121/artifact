# JPetStore微服务拆分 - 数据复核与错误修正报告

**复核时间**: 2025年12月16日  
**复核目的**: 确保实验严格按照ASE 2024论文标准执行，无数据错误  
**复核范围**: Ground Truth定义、三轮迭代MoJoFM计算、方案书要求

---

## ❌ 发现的严重错误

### 错误1：Ground Truth定义不准确

**问题描述**:
之前的计算中，未正确理解论文提供的 `jpetstore_classes.csv` 文件。

**错误内容**:
```python
# ❌ 错误的Ground Truth定义
GROUND_TRUTH_WRONG = {
    'order': {
        'Cart', 'CartItem', 'CartActionBean',  # CartActionBean错了！
        'Order', 'LineItem', 'OrderActionBean',
        'OrderMapper', 'OrderService', 'LineItemMapper',
        'Sequence', 'SequenceMapper', 'AbstractActionBean'
    }
}
```

**正确定义**（严格按照CSV文件）:
```python
# ✅ 正确的Ground Truth定义
GROUND_TRUTH_CORRECT = {
    'account': {
        'Account', 'AccountActionBean', 'AccountMapper', 'AccountService'
    },
    'catalog': {
        'Category', 'CategoryMapper', 'Product', 'ProductMapper',
        'Item', 'ItemMapper', 'CatalogService', 'CatalogActionBean',
        'CartActionBean'  # ⚠️ 关键：CartActionBean属于catalog！
    },
    'order': {
        'Cart', 'CartItem', 'Order', 'OrderActionBean',
        'OrderMapper', 'OrderService', 'LineItem', 'LineItemMapper',
        'Sequence', 'SequenceMapper'
    }
}
# AbstractActionBean标记为duplicate，在三个服务中都存在
```

**数据来源证据**:
```csv
# 来自artifact/case_studies/data/reference_decomposition/jpetstore_classes.csv
org.mybatis.jpetstore.web.actions.CartActionBean,CartActionBean,catalog,
                                                                 ^^^^^^^^
                                                                 明确是catalog！
```

---

### 错误2：MoJoFM计算错误

**原始计算结果（错误）**:

| 迭代 | 计算的MoJoFM | 状态 |
|------|--------------|------|
| 迭代1 | 95.83% | ❌ 高估 |
| 迭代2 | 95.83% | ✅ 偶然正确 |
| 迭代3 | 100.00% | ❌ 高估 |

**重新计算结果（正确）**:

| 迭代 | 正确的MoJoFM | 正确数 | 错误详情 |
|------|--------------|--------|----------|
| **迭代1** | **91.67%** | 22/24 | CartActionBean误分order + AbstractActionBean未分配 |
| **迭代2** | **95.83%** | 23/24 | CartActionBean误分order (AbstractActionBean在共享层✓) |
| **迭代3** | **95.83%** | 23/24 | CartActionBean误分order (AbstractActionBean在order✓) |

**计算差异原因**:
1. 错误地假设CartActionBean属于order服务
2. 实际上CartActionBean在Ground Truth中属于catalog服务
3. 三轮迭代的AI都一致性地将CartActionBean错误分配给了order

---

## 📊 详细复核结果

### 1. 迭代1：基础拆分

**AI的分配方案**:
- account: 4类 ✅ 全部正确
- catalog: 8类 ✅ 全部正确（但缺CartActionBean）
- order: 11类 ⚠️ 10类正确 + 1类错误(CartActionBean)

**错误分析**:
```
❌ CartActionBean: AI分配给order, Ground Truth是catalog
❌ AbstractActionBean: AI未分配, Ground Truth要求任一服务
```

**MoJoFM重新计算**:
- 正确: 22个类
- 错误: 2个类
- **MoJoFM = 91.67%** (不是95.83%)

---

### 2. 迭代2：依赖驱动拆分

**AI的分配方案**:
- account: 4类 ✅ 全部正确
- catalog: 8类 ✅ 全部正确（但缺CartActionBean）
- order: 11类 ⚠️ 10类正确 + 1类错误(CartActionBean)
- shared: 1类 (AbstractActionBean) ✅ 共享层处理正确

**错误分析**:
```
❌ CartActionBean: AI分配给order, Ground Truth是catalog
✅ AbstractActionBean: AI分配给共享层, 算正确（duplicate类任一服务皆可）
```

**MoJoFM重新计算**:
- 正确: 23个类
- 错误: 1个类
- **MoJoFM = 95.83%** (偶然正确，之前碰巧算对了)

---

### 3. 迭代3：专家优化拆分

**AI的分配方案**:
- account: 4类 ✅ 全部正确
- catalog: 8类 ✅ 全部正确（但缺CartActionBean）
- order: 12类 ⚠️ 11类正确 + 1类错误(CartActionBean)
  - 包含AbstractActionBean ✅

**错误分析**:
```
❌ CartActionBean: AI分配给order, Ground Truth是catalog
✅ AbstractActionBean: AI分配给order, 算正确（duplicate类任一服务皆可）
```

**MoJoFM重新计算**:
- 正确: 23个类
- 错误: 1个类
- **MoJoFM = 95.83%** (不是100%)

---

## 🔬 根因分析

### 为什么CartActionBean被误判？

**Ground Truth的定义逻辑**:
- CartActionBean虽然处理购物车(Cart)相关操作
- 但在论文的Ground Truth中，它被归类为catalog服务的一部分
- 可能原因：购物车的"添加商品"操作在catalog上下文中执行

**AI的推理逻辑**（三轮一致）:
```
"CartActionBean处理购物车操作，Cart和CartItem都在order服务，
因此将CartActionBean也分配到order服务以保持业务完整性"
```

**冲突点**:
- AI的领域驱动推理（Cart → order服务）
- Ground Truth的实际定义（CartActionBean → catalog服务）

**这是否是AI的错误？**
```
从业务逻辑角度：AI的分配合理（购物车应该在订单域）
从论文评估标准：AI错误（必须匹配Ground Truth）
```

---

## 📈 修正后的实验结果

### 真实的MoJoFM收敛曲线

```
MoJoFM收敛趋势（修正后）:
100% |                           
     |
 95% |              ●━━━━━━━━━━━● 迭代2-3 (95.83%)
     |            ╱
 90% |    ●━━━━━━ 迭代1 (91.67%)
     |   ╱
 85% |  ╱
     | ╱
 80% |╱
     +--------------------------------
       迭代1    迭代2    迭代3
```

**收敛特征**:
- 迭代1 → 2: +4.16pp (AbstractActionBean修正)
- 迭代2 → 3: +0pp (CartActionBean问题持续存在)

---

### 与论文工具对比（修正后）

| 工具/方法 | MoJoFM (类级别) | 排名 | 备注 |
|-----------|----------------|------|------|
| **Log2MS** | **100.00%** | 🥇 1 | 完美匹配 |
| **本研究 Copilot (迭代3)** | **95.83%** | 🥈 2 | 仅CartActionBean误判 |
| **MOSAIC** | **89.47%** | 🥉 3 | 论文最佳工具之一 |
| **Data-Centric** | 76.19% | 4 | 数据流分析 |
| **HyDec** | 57.14% | 5 | 混合方法 |
| **Mono2Micro** | 57.14% | 5 | IBM工具 |

**修正后的结论**:
- ✅ Copilot仍然排名第二，超越MOSAIC
- ✅ 达到95.83%，显著优于论文中6个工具
- ⚠️ 未达到100%，与Log2MS有4.17pp差距
- ⚠️ 差距来源于CartActionBean的业务理解偏差

---

## 📝 需要修正的文件清单

### 1. calculate_metrics.py ❌
**问题**: Ground Truth定义错误
**修正**: 
```python
GROUND_TRUTH = {
    'catalog': {
        ...,
        'CartActionBean'  # 移动到catalog
    },
    'order': {
        # 移除CartActionBean
        ...
    }
}
```

### 2. 迭代1_基础拆分/evaluation_metrics.csv ❌
**错误值**: `MoJoFM,95.83,%`
**正确值**: `MoJoFM,91.67,%`
**其他指标**: 需更新服务级别精确率/召回率

### 3. 迭代2_依赖驱动/evaluation_metrics.csv ✅
**当前值**: `MoJoFM,95.83,%`
**状态**: 偶然正确（虽然Ground Truth定义错了，但结果碰巧对）

### 4. 迭代3_专家优化/evaluation_metrics.csv ❌
**错误值**: `MoJoFM,100.00,%`
**正确值**: `MoJoFM,95.83,%`
**需修正**: 移除"完美匹配"相关描述

### 5. 指标评估报告.md ❌
**需全面修订**:
- 所有MoJoFM数值
- 收敛曲线图
- 论文对比表（从并列第一改为第二）
- 错误分析（增加CartActionBean问题）

### 6. AI微服务拆分方案书.md ❌
**问题**: Ground Truth定义章节
**修正**: 更新catalog服务包含CartActionBean

---

## ✅ 复核确认的正确内容

### 1. AbstractActionBean处理 ✅
**duplicate标记理解正确**:
- 在Ground Truth中标记为duplicate=TRUE
- 在account、catalog、order三个服务中都出现
- MoJoFM计算时，只要分配到任一服务即算正确

**迭代演进正确**:
- 迭代1: 未分配 ❌
- 迭代2: 共享层 ✅
- 迭代3: order服务 ✅

### 2. 其他23个类的分配 ✅
**account服务（4类）**: 三轮迭代全部正确
**catalog服务（除CartActionBean外7类）**: 三轮迭代全部正确
**order服务（除CartActionBean外10类）**: 三轮迭代全部正确

### 3. TurboMQ估算 ✅
**估算方法合理**: 基于MoJoFM的85-95范围
**说明完整**: 明确指出需要依赖图数据进行精确计算

---

## 🎯 最终结论

### 实验有效性

**✅ 实验设计严格**:
- 三轮迭代设计合理
- 提示词工程方法科学
- 数据采集流程完整

**✅ 数据质量高**:
- 除CartActionBean外，其他23/24类全部正确
- AbstractActionBean的处理演进体现了AI学习过程

**⚠️ Ground Truth理解偏差**:
- CartActionBean的归属是AI与GT的唯一分歧
- 这反映了业务建模视角的差异（AI倾向购物车→订单域）

### 研究贡献（修正后）

**1. 排名修正**: 从并列第一 → 第二名
- Log2MS: 100%
- Copilot: 95.83% (仅次于Log2MS)
- MOSAIC: 89.47%

**2. 核心价值保持**:
- 依然显著优于MOSAIC等6个工具
- 95.83%的准确率在工业应用中足够高
- 提示工程方法的有效性得到验证

**3. 新的研究发现**:
- CartActionBean问题揭示了AI业务理解与专家定义的差异
- 这种差异可能在某些场景下，AI的判断更合理

---

## 📋 修正行动清单

- [ ] 更新 calculate_metrics.py
- [ ] 重新运行指标计算脚本
- [ ] 修正迭代1/evaluation_metrics.csv
- [ ] 修正迭代3/evaluation_metrics.csv
- [ ] 全面修订指标评估报告.md
- [ ] 更新AI微服务拆分方案书.md
- [ ] 验证所有数值一致性
- [ ] 生成最终修正版报告

---

*复核完成时间: 2025年12月16日*
*复核人: GitHub Copilot*
*复核状态: 发现严重错误，需要全面修正*
